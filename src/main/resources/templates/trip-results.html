<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{base :: layout(~{::title}, ~{::main}, ~{::script})}" dir="rtl" lang="he">
<head>
  <title>CheapTrips - תוצאות חיפוש</title>
</head>
<body>

<main>
  <div class="container">
    <!-- Results Summary Header -->
    <div class="row mb-4">
      <div class="col">
        <h2 class="text-center mb-3">תוצאות החיפוש שלך</h2>
        <div id="tripSummary" class="alert alert-info text-center"></div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="resultTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="flights-tab" data-bs-toggle="tab" data-bs-target="#flights" type="button">טיסות</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button">חדשות מקומיות</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="places-tab" data-bs-toggle="tab" data-bs-target="#places" type="button">מקומות לביקור</button>
      </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="resultTabsContent">
      <!-- Flights Tab -->
      <div class="tab-pane fade show active" id="flights" role="tabpanel">
        <div class="row" id="flightsList">
          <!-- Flight cards will be inserted here -->
        </div>
      </div>

      <!-- News Tab -->
      <div class="tab-pane fade" id="news" role="tabpanel">
        <div class="row" id="newsList">
          <!-- News cards will be inserted here -->
        </div>
      </div>

      <!-- Places Tab -->
      <div class="tab-pane fade" id="places" role="tabpanel">
        <div class="accordion" id="placesAccordion">
          <!-- Places categories will be inserted here -->
        </div>
      </div>
    </div>
  </div>
</main>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
      const tripData = JSON.parse(localStorage.getItem('tripData'));

      if (!tripData) {
          window.location.href = '/';
          return;
      }

      function formatDate(dateString) {
          return new Date(dateString).toLocaleDateString('he-IL', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
          });
      }

      function capitalizeWords(str) {
          return str.split(' ').map(word =>
              word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
          ).join(' ');
      }

      function formatCategoryName(name) {
          return capitalizeWords(name.replace(/_/g, ' '));
      }

      function updateTripSummary() {
          const flight = tripData.flight;
          const summary = document.getElementById('tripSummary');
          summary.innerHTML = `
              <div class="text-center" style="font-size: 1.2rem; direction: rtl; text-align: right;">
                  <div class="fw-bold mb-2">
                      טיסה ${flight.destination.city.cityName.toUpperCase()} ⟵ ${flight.origin.city.cityName.toUpperCase()}
                  </div>
                  <div class="trip-details d-flex flex-column align-items-end">
                      ${flight.departure_at ? `
                          <div class="mb-2 d-flex gap-2 justify-content-end">
                              <span>${formatDate(flight.departure_at)}</span>
                              <span class="fw-bold">:יציאה</span>
                          </div>
                      ` : ''}
                      ${flight.return_at ? `
                          <div class="d-flex gap-2 justify-content-end">
                              <span>${formatDate(flight.return_at)}</span>
                              <span class="fw-bold">:חזרה</span>
                          </div>
                      ` : ''}
                  </div>
              </div>
          `;
      }


      function renderFlights() {
          const flightsList = document.getElementById('flightsList');
          const tickets = tripData.flight.ticketKeys;

          flightsList.innerHTML = tickets.map(ticket => `
              <div class="col-12 col-md-6 mb-4">
                  <div class="card h-100">
                      <div class="card-body text-end">
                          <h5 class="card-title">${ticket.airlineDetails.name}</h5>
                          <div class="d-flex justify-content-between mb-3">
                              <div class="text-end">
                                  <small>מחיר:</small>
                                  <p class="mb-0">${ticket.price} ${tripData.flight.currency}</p>
                              </div>
                              <div class="text-end">
                                  <small>מספר טיסה:</small>
                                  <p class="mb-0">${ticket.flightNumber}</p>
                              </div>
                          </div>
                          <div class="mb-3 text-end">
                              <small>תאריך יציאה:</small>
                              <p class="mb-0">${formatDate(ticket.departureAt)}</p>
                          </div>
                          ${ticket.returnAt ? `
                              <div class="mb-3 text-end">
                                  <small>תאריך חזרה:</small>
                                  <p class="mb-0">${formatDate(ticket.returnAt)}</p>
                              </div>
                          ` : ''}
                          <div class="text-end">
                              <small>מספר עצירות:</small>
                              <p class="mb-0">${ticket.transfers}</p>
                          </div>
                      </div>
                      <div class="card-footer text-end">
                          <small class="text-muted">תוקף המחיר עד: ${formatDate(ticket.expiresAt)}</small>
                      </div>
                  </div>
              </div>
          `).join('');
      }

      function renderNews() {
          const newsList = document.getElementById('newsList');
          const news = tripData.news.newsList;

          newsList.innerHTML = news.map(article => `
              <div class="col-12 col-md-6 col-lg-4 mb-4">
                  <div class="card h-100">
                      ${article.urlToImage ? `
                          <img src="${article.urlToImage}" class="card-img-top" alt="${article.title}"
                               onerror="this.onerror=null; this.src='/placeholder-image.jpg';">
                      ` : ''}
                      <div class="card-body text-end">
                          <h5 class="card-title">${article.title}</h5>
                          <p class="card-text">${article.description || ''}</p>
                          <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted">${new Date(article.publishedAt).toLocaleDateString('he-IL')}</small>
                              <small class="text-muted">${article.source_name}</small>
                          </div>
                      </div>
                      <div class="card-footer">
                          <a href="${article.url}" target="_blank" class="btn btn-outline-primary btn-sm w-100">קרא עוד</a>
                      </div>
                  </div>
              </div>
          `).join('');
      }

      function renderPlaces() {
          const placesAccordion = document.getElementById('placesAccordion');
          const categories = tripData.placesData.kindsCategory.categories;

          placesAccordion.innerHTML = categories.map((category, index) => `
              <div class="accordion-item">
                  <h2 class="accordion-header">
                      <button class="accordion-button ${index !== 0 ? 'collapsed' : ''} text-end" type="button"
                              data-bs-toggle="collapse" data-bs-target="#category${index}">
                          <span class="fw-bold">${formatCategoryName(category.name)}</span>
                          <span class="ms-2">(${category.places.length})</span>
                      </button>
                  </h2>
                  <div id="category${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
                       data-bs-parent="#placesAccordion">
                      <div class="accordion-body">
                          <div class="row">
                              ${category.places.map(place => `
                                  <div class="col-12 col-md-6 mb-4">
                                      <div class="card h-100">
                                          ${place.image ? `
                                              <img src="${place.image}"
                                                   class="card-img-top"
                                                   alt="${place.name}"
                                                   onerror="this.parentElement.querySelector('.card-img-top').remove()"
                                                   loading="lazy">
                                          ` : ''}
                                          <div class="card-body text-end">
                                              <h5 class="card-title">${formatCategoryName(place.name)}</h5>
                                              ${place.wikipedia_extracts ? `
                                                  <p class="card-text">${place.wikipedia_extracts}</p>
                                              ` : ''}
                                              ${place.address ? `
                                                  <p class="card-text">
                                                      <small class="text-muted">
                                                          ${[
                                                              place.address.road,
                                                              place.address.city,
                                                              place.address.country
                                                          ].filter(Boolean).join('، ')}
                                                      </small>
                                                  </p>
                                              ` : ''}
                                              ${place.rate ? `
                                                  <div class="mb-2">
                                                      <small class="text-muted">דירוג: ${place.rate}</small>
                                                  </div>
                                              ` : ''}
                                          </div>
                                          ${place.url ? `
                                              <div class="card-footer">
                                                  <a href="${place.url}" target="_blank"
                                                     class="btn btn-outline-primary btn-sm w-100">מידע נוסף</a>
                                              </div>
                                          ` : ''}
                                      </div>
                                  </div>
                              `).join('')}
                          </div>
                      </div>
                  </div>
              </div>
          `).join('');
      }



      try {
          updateTripSummary();
          renderFlights();
          renderNews();
          renderPlaces();
      } catch (error) {
          console.error('Error rendering trip results:', error);
          alert('אירעה שגיאה בטעינת התוצאות. אנא נסה שנית.');
      }

      document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
          tab.addEventListener('shown.bs.tab', function(event) {
              console.log('Tab changed:', event.target.id);
          });
      });
  });
</script>

</body>
</html>