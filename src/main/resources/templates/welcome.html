<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{base :: layout(~{::title}, ~{::main}, ~{::script})}" lang="en">

<head>
    <title>CheapTrips - חיפוש טיסות</title>
</head>
<body>

<main>
    <h2 class="text-center mb-4 right_to_left">גלה את הטיסות הזולות, חדשות מקומיות, ומקומות תיירות לחופשה שלך – פשוט וקל</h2>
    <div class="card">
        <div class="card-body">
            <form id="searchForm">
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="originInput" class="form-label">מוצא</label>
                        <div class="dropdown-container">
                            <input type="text" class="form-control dropdown-input" id="originInput" placeholder="Tel Aviv-Yafo (TLV) - Israel" value="Tel Aviv-Yafo (TLV) - Israel">
                            <div id="originDropdown" class="dropdown-menu"></div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="destinationInput" class="form-label">יעד</label>
                        <div class="dropdown-container">
                            <input type="text" class="form-control dropdown-input" id="destinationInput" placeholder="בחר יעד">
                            <div id="destinationDropdown" class="dropdown-menu"></div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="departDate" class="form-label">יציאה</label>
                        <input type="date" class="form-control" id="departDate">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="returnDate" class="form-label">חזרה</label>
                        <input type="date" class="form-control" id="returnDate">
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="showPlacesCard">
                    <label class="form-check-label" for="showPlacesCard">הצג אפשרויות מתקדמות</label>
                </div>

                <div id="placesCard" class="card mb-3" style="display: none;">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="radius" class="form-label">רדיוס (ק"מ)</label>
                                <input type="range" class="form-range" id="radius" min="10" max="50" step="1" value="10">
                                <div class="d-flex justify-content-between">
                                    <span>10 ק"מ</span>
                                    <span>50 ק"מ</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="places" class="form-label">מספר מקומות</label>
                                <input type="number" class="form-control" id="places" min="1" max="10" value="1">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success w-100">חיפוש</button>
            </form>
        </div>
    </div>
</main>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
    // Check if the JWT token exists in localStorage
    const jwtToken = localStorage.getItem('jwtToken');

    if (!jwtToken) {
        const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
        warningModal.show();
    }

    // Add event listeners for the Login and Sign Up buttons
    document.getElementById('loginRedirect')?.addEventListener('click', function() {
        window.location.href = '/login'; // Adjust the path for your login page
    });

    document.getElementById('signupRedirect')?.addEventListener('click', function() {
        window.location.href = '/signup'; // Adjust the path for your sign-up page
    });

    console.log('DOM fully loaded and parsed');

    // Check if airport data is already cached in localStorage
    const cachedAirportsCities = localStorage.getItem('airportsCities');
    console.log('Checking for cached airport data:', cachedAirportsCities);

    if (cachedAirportsCities) {
        console.log('Using cached airport data');
        populateDropdowns(JSON.parse(cachedAirportsCities));
    } else {
        console.log('No cached data, fetching from server...');
        fetch('/cheap-trip/combined-city-airport-data', {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            console.log('Received response:', response);
            return response.json();
        })
        .then(data => {
            console.log('Fetched airport data:', data);
            // Ensure data is an array
            const airportsCities = Array.isArray(data) ? data : [data];
            console.log('Using airport data:', airportsCities);

            // Cache the data in localStorage
            localStorage.setItem('airportsCities', JSON.stringify(airportsCities));
            console.log('Airport data cached in localStorage');

            // Populate the dropdowns
            populateDropdowns(airportsCities);
        })
        .catch(error => console.error('Error fetching airport data:', error));
    }

    // Function to populate dropdowns
    function populateDropdowns(data) {
        const originDropdown = document.getElementById('originDropdown');
        const destinationDropdown = document.getElementById('destinationDropdown');

        if (!originDropdown || !destinationDropdown) {
            console.error('Dropdown elements not found');
            return;
        }

        originDropdown.innerHTML = '';
        destinationDropdown.innerHTML = '';

        data.forEach(item => {
            const option = document.createElement('a');
            option.classList.add('dropdown-item');
            option.href = '#';
            option.textContent = `${item.city.name} (${item.airport.code}) - ${item.country.name}`;
            option.dataset.value = JSON.stringify(item);

            const clonedOption = option.cloneNode(true);

            originDropdown.appendChild(clonedOption);
            destinationDropdown.appendChild(option);
        });

        // Add click event listeners to all dropdown items
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', handleDropdownItemClick);
        });
    }

    // Function to handle dropdown item click
    function handleDropdownItemClick(e) {
        e.preventDefault();
        const dropdownContainer = e.target.closest('.dropdown-container');
        const input = dropdownContainer.querySelector('.dropdown-input');
        const dropdown = dropdownContainer.querySelector('.dropdown-menu');

        input.value = e.target.textContent;
        input.dataset.selected = e.target.dataset.value;
        dropdown.style.display = 'none';

        console.log(`Selected: ${input.value}`);
        console.log(`Selected data: ${input.dataset.selected}`);
    }

    // Function to filter dropdown based on input value
    function filterDropdown(input, dropdown) {
        const filter = input.value.toUpperCase();
        const items = dropdown.getElementsByTagName('a');
        let hasVisibleItems = false;
        for (let i = 0; i < items.length; i++) {
            const txtValue = items[i].textContent || items[i].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].style.display = "";
                hasVisibleItems = true;
            } else {
                items[i].style.display = "none";
            }
        }
        dropdown.style.display = hasVisibleItems ? 'block' : 'none';
    }

    // Add event listeners for input fields
    const originInput = document.getElementById('originInput');
    const destinationInput = document.getElementById('destinationInput');
    const originDropdown = document.getElementById('originDropdown');
    const destinationDropdown = document.getElementById('destinationDropdown');

    if (originInput && originDropdown) {
        originInput.addEventListener('input', function() {
            filterDropdown(this, originDropdown);
        });
        originInput.addEventListener('focus', function() {
            originDropdown.style.display = 'block';
        });
    }

    if (destinationInput && destinationDropdown) {
        destinationInput.addEventListener('input', function() {
            filterDropdown(this, destinationDropdown);
        });
        destinationInput.addEventListener('focus', function() {
            destinationDropdown.style.display = 'block';
        });
    }

    // Toggle the advanced options card
    const showPlacesCard = document.getElementById('showPlacesCard');
    const placesCard = document.getElementById('placesCard');
    if (showPlacesCard && placesCard) {
        showPlacesCard.addEventListener('change', function() {
            console.log('Advanced options toggled. Checked:', this.checked);
            placesCard.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Handle form submission
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const originData = JSON.parse(originInput.dataset.selected || '{}');
            const destinationData = JSON.parse(destinationInput.dataset.selected || '{}');
            const departDate = document.getElementById('departDate')?.value;
            const returnDate = document.getElementById('returnDate')?.value;
            console.log('Search form submitted');
            console.log('Form data - Origin:', originData, 'Destination:', destinationData, 'Depart Date:', departDate, 'Return Date:', returnDate);
            // Here you would typically send this data to your server or perform further actions
        });
    }

    // Close dropdown if click outside
    document.addEventListener('click', function(event) {
        if (!event.target.matches('.dropdown-input') && !event.target.matches('.dropdown-item')) {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            dropdowns.forEach(dropdown => dropdown.style.display = 'none');
        }
    });
});
</script>
</body>
</html>
